<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment App Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: WhatsApp Inspired Neutrals -->
    <!-- Application Structure Plan: A tab-based SPA structure was chosen for superior usability. It separates the primary user task (sending money via the 'Chat' tab) from secondary tasks like reviewing past payments ('History' tab) and managing account details ('Settings' tab). This non-linear, task-oriented structure is more intuitive and scalable than a simple linear progression of screens. The core payment flow is handled via a sequence of modals to maintain context and focus the user on the transaction process from initiation to completion. -->
    <!-- Visualization & Content Choices: Report Info: Transaction list -> Goal: Inform/Compare -> Viz: Interactive list with filters and a summary bar chart (Chart.js/Canvas) -> Interaction: Users can filter transactions by status (Completed, Incomplete) to quickly find information. The chart provides a high-level comparison of spending by recipient. Report Info: Settings options -> Goal: Organize/Inform -> Viz: Toggled list (HTML/CSS) -> Interaction: Users can tap options to navigate or toggle switches to change security settings. This approach makes complex information easily digestible and interactive. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { color: #16a34a; border-color: #16a34a; }
        .tab-inactive { color: #6b7280; border-color: transparent; }
        .modal-hidden { display: none; }
        .pin-digit {
            width: 24px;
            height: 24px;
            border-bottom: 2px solid #ccc;
            text-align: center;
            font-size: 20px;
            line-height: 24px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app-container" class="max-w-md mx-auto bg-white shadow-lg h-screen flex flex-col">

        <!-- Main Content -->
        <main id="main-content" class="flex-grow overflow-y-auto pb-20">
            <!-- Chat List View (New Initial Page) -->
            <div id="view-chat-list" class="page-view p-4">
                <div class="text-center mb-4 border-b pb-4">
                    <h1 class="text-xl font-bold">Chats</h1>
                    <p class="text-sm text-gray-500">Select a conversation to view chat history and initiate payments.</p>
                </div>
                <ul id="conversation-list" class="space-y-3">
                    <!-- Conversation items will be rendered here by JavaScript -->
                </ul>
            </div>

            <!-- Individual Chat View (Previously view-chat) -->
            <div id="view-individual-chat" class="page-view hidden p-4">
                 <div class="mb-4 border-b pb-4 flex items-center justify-between">
                    <button class="text-gray-600 hover:text-gray-800 p-2 rounded-full" onclick="navigateToTab('chat-list')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold flex-grow text-center" id="individual-chat-header"></h1>
                    <div class="w-10"></div> <!-- Spacer to balance the back button -->
                </div>
                <div class="text-center mb-4">
                    <p class="text-sm text-gray-500">This section simulates the chat where a payment can be initiated. Click the payment suggestion or the dollar icon below to start the payment process.</p>
                </div>
                <div id="chat-messages" class="space-y-3">
                    <!-- Chat messages will be rendered here by JavaScript -->
                </div>
                <div class="fixed bottom-16 left-1/2 -translate-x-1/2 w-full max-w-md px-4 py-2 bg-white border-t">
                    <div class="flex items-center">
                        <input type="text" placeholder="Type a message" class="flex-grow border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        <button class="ml-2 text-gray-500 p-2">üìé</button>
                        <button class="ml-1 text-gray-500 p-2">üé§</button>
                        <button class="ml-1 bg-green-600 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl" onclick="startPayment(null, appState.currentRecipient)">$</button>
                    </div>
                </div>
            </div>

            <!-- History View -->
            <div id="view-history" class="page-view hidden">
                 <div class="p-4 border-b">
                    <h1 class="text-xl font-bold text-center">Transaction History</h1>
                    <p class="text-sm text-gray-500 text-center mt-2">Here you can review all your past transactions. Use the filters to sort through your payment history and see a visual summary of your spending by recipient in the chart below.</p>
                </div>
                <div class="p-4">
                    <div class="chart-container relative w-full max-w-xl mx-auto h-64 sm:h-80">
                        <canvas id="transactionsChart"></canvas>
                    </div>
                </div>
                <div class="px-4 pt-4">
                    <div class="flex justify-center space-x-2 mb-4 border-b pb-4 flex-wrap">
                        <button class="history-filter-btn px-4 py-1.5 text-sm font-semibold rounded-full bg-green-600 text-white m-1" data-filter="all">All</button>
                        <button class="history-filter-btn px-4 py-1.5 text-sm font-semibold rounded-full bg-gray-200 text-gray-700 m-1" data-filter="completed">Completed</button>
                        <button class="history-filter-btn px-4 py-1.5 text-sm font-semibold rounded-full bg-gray-200 text-gray-700 m-1" data-filter="incomplete">Incomplete</button>
                        <button class="history-filter-btn px-4 py-1.5 text-sm font-semibold rounded-full bg-gray-200 text-gray-700 m-1" data-filter="outgoing">Outgoing</button>
                        <button class="history-filter-btn px-4 py-1.5 text-sm font-semibold rounded-full bg-gray-200 text-gray-700 m-1" data-filter="incoming">Incoming</button>
                        <button class="history-filter-btn px-4 py-1.5 text-sm font-semibold rounded-full bg-gray-200 text-gray-700 m-1" data-filter="pending">Pending</button>
                    </div>
                    <ul id="transaction-list" class="space-y-4"></ul>
                </div>
            </div>

            <!-- Settings View -->
            <div id="view-settings" class="page-view hidden">
                <div class="p-4 border-b">
                    <h1 class="text-xl font-bold text-center">Settings</h1>
                    <p class="text-sm text-gray-500 text-center mt-2">Manage your linked accounts, adjust security preferences, and access your transaction history. Your settings control how you send and protect your money.</p>
                </div>
                <div class="p-4 space-y-6">
                    <div>
                        <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Linked Accounts</h2>
                        <div id="linked-accounts-list" class="bg-white rounded-lg shadow-sm">
                            <!-- Linked accounts will be rendered here by JavaScript -->
                        </div>
                    </div>
                     <div>
                        <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Security Options</h2>
                        <div class="bg-white rounded-lg shadow-sm divide-y">
                            <div class="flex justify-between items-center p-3">
                                <label for="pin-toggle">Require PIN</label>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="pin-toggle" id="pin-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                    <label for="pin-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-3">
                               <label for="faceid-toggle">Enable Face ID</label>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="faceid-toggle" id="faceid-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                    <label for="faceid-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-3">
                               <label for="fingerprint-toggle">Enable Fingerprint</label>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="fingerprint-toggle" id="fingerprint-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                    <label for="fingerprint-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div>
                        <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">View Transaction History</h2>
                        <div class="bg-white rounded-lg shadow-sm">
                            <a href="#" class="flex justify-between items-center p-3 hover:bg-gray-50" onclick="navigateToTab('history')">
                                <span>See All Transactions</span>
                                <span class="text-gray-400">&gt;</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Tab Navigation -->
        <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white border-t">
            <div class="flex justify-around">
                <button class="nav-tab flex-1 text-center py-3 border-b-2 tab-active" data-view="chat-list">
                    <span class="text-2xl">üí¨</span>
                    <span class="block text-xs">Chats</span>
                </button>
                <button class="nav-tab flex-1 text-center py-3 border-b-2 tab-inactive" data-view="history">
                    <span class="text-2xl">üìñ</span>
                    <span class="block text-xs">History</span>
                </button>
                <button class="nav-tab flex-1 text-center py-3 border-b-2 tab-inactive" data-view="settings">
                    <span class="text-2xl">‚öôÔ∏è</span>
                    <span class="block text-xs">Settings</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <script>
        // Define the initial state of transactions
        const initialTransactions = [
            { id: '1', name: 'Samuel', date: 'Today', amount: 50.00, status: 'completed', txId: '6789012345', bankAccount: 'MyBank Checking', type: 'outgoing' },
            { id: '2', name: 'Michelle', date: 'Apr 18', amount: 100.00, status: 'completed', txId: '5678901234', bankAccount: 'MyBank Checking', type: 'outgoing' },
            { id: '3', name: 'Daniel', date: 'Apr 15', amount: 25.00, status: 'completed', txId: '4567019283', bankAccount: 'MyBank Checking', type: 'outgoing' },
            { id: '4', name: 'Ethan', date: 'Apr 12', amount: 50.00, status: 'incomplete', txId: '3456780129', bankAccount: 'MyBank Checking', type: 'outgoing' },
            { id: '5', name: 'Stephanie', date: 'Mar 21', amount: 40.00, status: 'completed', txId: '2345678901', bankAccount: 'MyBank Checking', type: 'outgoing' },
            // Changed status to 'pending' for incoming transactions to simulate acceptance flow
            { id: '6', name: 'Alex Chen', date: 'Today', amount: 75.00, status: 'pending', txId: '9876543210', bankAccount: 'Unknown', type: 'incoming' },
            { id: '7', name: 'Sarah Miller', date: 'Yesterday', amount: 30.00, status: 'pending', txId: '1098765432', bankAccount: 'Unknown', type: 'incoming' },
        ];

        // Define initial conversations for the chat list
        const initialConversations = [
            { 
                id: 'convo-ethan', 
                name: 'Ethan', 
                lastMessage: 'Awesome! Can you send me your share, $50, for the tickets? This is a very long message to test the wrapping functionality and ensure it does not overflow the component.', 
                time: 'Today 11:20 AM', 
                unread: 1,
                messages: [
                    { sender: 'user', text: 'Hey Ethan, did you get those concert tickets?', time: '11:15 AM' },
                    { sender: 'other', text: 'Yep, just confirmed them! Looking forward to it!', time: '11:17 AM' },
                    { sender: 'user', text: 'Awesome! Can\'t wait. What\'s the plan for getting there?', time: '11:18 AM' },
                    { sender: 'other', text: 'I was thinking we could carpool. I\'ll drive if you\'re good with that.', time: '11:19 AM' },
                    { sender: 'other', text: 'Awesome! Can you send me your share, $50, for the tickets? This is a very long message to test the wrapping functionality and ensure it does not overflow the component.', time: '11:20 AM' },
                ]
            }, 
            { 
                id: 'convo-samuel', 
                name: 'Samuel', 
                lastMessage: 'Thanks for the lunch!', 
                time: 'Yesterday 10:00 AM', 
                unread: 0,
                messages: [
                    { sender: 'other', text: 'Hey, thanks again for lunch yesterday!', time: '09:30 AM' },
                    { sender: 'user', text: 'No problem, it was great catching up!', time: '09:31 AM' },
                    { sender: 'other', text: 'Totally! Just wanted to confirm if you got the payment I sent for my share?', time: '09:32 AM' },
                    { sender: 'user', text: 'Yep, got it! Thanks!', time: '09:33 AM' }
                ]
            },
            { 
                id: 'convo-michelle', 
                name: 'Michelle', 
                lastMessage: 'Did you get my transfer?', 
                time: 'Apr 29 09:00 AM', 
                unread: 0,
                messages: [
                    { sender: 'user', text: 'Hi Michelle, just checking if you received the transfer for the group gift?', time: '02:05 PM' },
                    { sender: 'other', text: 'Oh, hey! Yes, I did! Thanks so much, that was quick!', time: '02:07 PM' },
                    { sender: 'user', text: 'Great! Just wanted to make sure.', time: '02:08 PM' }
                ]
            }, 
            { 
                id: 'convo-daniel', 
                name: 'Daniel', 
                lastMessage: 'Meeting confirmed for Friday.', 
                time: 'Apr 15 08:00 AM', 
                unread: 0,
                messages: [
                    { sender: 'other', text: 'Hey Daniel, just a reminder about our meeting on Friday at 10 AM. Agenda is in the invite.', time: '04:00 PM' },
                    { sender: 'user', text: 'Got it, thanks for the reminder! I\'ll be there.', time: '04:01 PM' },
                    { sender: 'other', text: 'Perfect. See you then!', time: '04:02 PM' }
                ]
            }, 
            { 
                id: 'convo-stephanie', 
                name: 'Stephanie', 
                lastMessage: 'See you at the gym!', 
                time: 'Mar 21 07:00 AM', 
                unread: 0,
                messages: [
                    { sender: 'user', text: 'Are you still planning on hitting the gym later?', time: '05:30 PM' },
                    { sender: 'other', text: 'Absolutely! Just finishing up work. Be there in about 30?', time: '05:32 PM' },
                    { sender: 'user', text: 'Sounds good! I\'m already here, warming up.', time: '05:33 PM' },
                    { sender: 'other', text: 'Nice! See you soon!', time: '05:34 PM' }
                ]
            }, 
            // Updated messages to reflect pending incoming transactions
            { 
                id: 'convo-alex', 
                name: 'Alex Chen', 
                lastMessage: 'Just sent you $75. Please accept.', 
                time: 'Today 10:00 AM', 
                unread: 1,
                messages: [
                    { sender: 'other', text: 'Hey, just sent you $75. Please accept.', time: '10:00 AM' },
                    { sender: 'user', text: 'Okay, I\'ll accept it now!', time: '10:01 AM' },
                ]
            }, 
            { 
                id: 'convo-sarah', 
                name: 'Sarah Miller', 
                lastMessage: 'Transferred the $30. Let me know when you get it. This message is also quite long to ensure proper wrapping and alignment.', 
                time: 'Yesterday 03:00 PM', 
                unread: 1,
                messages: [
                    { sender: 'other', text: 'Transferred the $30. Let me know when you get it. This message is also quite long to ensure proper wrapping and alignment.', time: '03:00 PM' },
                    { sender: 'user', text: 'Got it, accepting now!', time: '03:01 PM' },
                ]
            }, 
        ];

        const appState = {
            currentView: 'chat-list', // Start with the chat list view
            transactions: [...initialTransactions],
            conversations: [...initialConversations], // Store conversation data
            linkedAccounts: ['MyBank Checking'], // Initial linked account
            transactionsChart: null,
            currentPaymentAmount: 0,
            currentRecipient: '', // Will be set when opening an individual chat
            currentAccount: 'MyBank Checking', // Default account for new payments
            currentPin: '',
            correctPin: '1234',
            currentReceiveAmount: 0, // New: amount for incoming transaction
            currentReceiveSender: '', // New: sender for incoming transaction
            currentReceiveTxId: '', // New: ID of the pending incoming transaction
            paymentFlowActive: false, // Flag to indicate if bank linking is from payment flow (sending)
            receiveFlowActive: false // New: Flag to indicate if bank linking is from receive payment flow
        };

        const modalContainer = document.getElementById('modal-container');

        function navigateToTab(viewId) {
            document.querySelectorAll('.page-view').forEach(view => view.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('tab-active');
                tab.classList.add('tab-inactive');
                if (tab.dataset.view === viewId) {
                    tab.classList.add('tab-active');
                    tab.classList.remove('tab-inactive');
                }
            });
            appState.currentView = viewId;

            if (viewId === 'history') {
                renderTransactionHistory('all');
                renderTransactionsChart();
            } else if (viewId === 'chat-list') {
                renderChatList();
            } else if (viewId === 'settings') {
                renderLinkedAccounts(); // Render linked accounts when navigating to settings
            }
        }

        // Helper function to convert chat time strings into Date objects for sorting
        function getSortableChatDate(timeString) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);

            if (timeString.startsWith('Today')) {
                const timePart = timeString.replace('Today ', '');
                const [hours, minutes, period] = timePart.match(/(\d+):(\d+) (AM|PM)/).slice(1);
                let h = parseInt(hours);
                if (period === 'PM' && h < 12) h += 12;
                if (period === 'AM' && h === 12) h = 0; // Midnight
                const dateWithTime = new Date(today);
                dateWithTime.setHours(h, parseInt(minutes), 0, 0);
                return dateWithTime;
            } else if (timeString.startsWith('Yesterday')) {
                const timePart = timeString.replace('Yesterday ', '');
                const [hours, minutes, period] = timePart.match(/(\d+):(\d+) (AM|PM)/).slice(1);
                let h = parseInt(hours);
                if (period === 'PM' && h < 12) h += 12;
                if (period === 'AM' && h === 12) h = 0; // Midnight
                const dateWithTime = new Date(yesterday);
                dateWithTime.setHours(h, parseInt(minutes), 0, 0);
                return dateWithTime;
            } else {
                // For specific dates like "Apr 15 08:00 AM"
                try {
                    // Append current year to make it a full date string for parsing
                    const fullDateString = `${timeString.split(' ')[0]} ${timeString.split(' ')[1]}, ${currentYear} ${timeString.split(' ').slice(2).join(' ')}`;
                    const parsedDate = new Date(fullDateString);
                    if (!isNaN(parsedDate.getTime())) { // Check if date is valid
                        return parsedDate;
                    }
                } catch (e) {
                    console.error("Error parsing date string:", timeString, e);
                }
                return new Date(0); // Fallback for unparseable dates, push to end
            }
        }

        function renderChatList() {
            const conversationList = document.getElementById('conversation-list');
            conversationList.innerHTML = ''; // Clear previous list

            const sortedConversations = [...appState.conversations].sort((a, b) => {
                // Primary sort: Unread messages first
                if (a.unread > 0 && b.unread === 0) return -1;
                if (a.unread === 0 && b.unread > 0) return 1;

                // Secondary sort: By date/time (most recent first)
                const dateA = getSortableChatDate(a.time);
                const dateB = getSortableChatDate(b.time);

                return dateB.getTime() - dateA.getTime(); // Descending order
            });

            sortedConversations.forEach(convo => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 bg-white rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 transition-colors';
                li.onclick = () => openIndividualChat(convo.name);

                // Truncate lastMessage for preview
                const maxMessageLength = 40; // Define max length for preview
                const displayMessage = convo.lastMessage.length > maxMessageLength ? 
                                       convo.lastMessage.substring(0, maxMessageLength) + '...' : 
                                       convo.lastMessage;

                // Determine how to display the time string
                let displayedTime = convo.time;
                if (convo.time.startsWith('Today') || convo.time.startsWith('Yesterday')) {
                    // Keep full string for Today/Yesterday with time
                    displayedTime = convo.time;
                } else {
                    // For specific dates, just show the date part (e.g., "Apr 29")
                    const parts = convo.time.split(' ');
                    if (parts.length >= 2) {
                        displayedTime = `${parts[0]} ${parts[1]}`;
                    }
                }


                li.innerHTML = `
                    <div class="flex-grow pl-2">
                        <div class="font-semibold text-lg">${convo.name}</div>
                        <div class="text-sm text-gray-600">${displayMessage}</div>
                    </div>
                    <div class="flex flex-col items-end text-right text-xs text-gray-500 flex-shrink-0 ml-2">
                        <span>${displayedTime}</span>
                        ${convo.unread > 0 ? `<span class="mt-1 bg-green-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${convo.unread}</span>` : ''}
                    </div>
                `;
                conversationList.appendChild(li);
            });
        }

        function openIndividualChat(recipientName) {
            appState.currentRecipient = recipientName;

            // Find the conversation and set its unread count to 0
            const convoIndex = appState.conversations.findIndex(c => c.name === recipientName);
            if (convoIndex !== -1) {
                appState.conversations[convoIndex].unread = 0;
            }

            navigateToTab('individual-chat'); // Navigate to the individual chat view
            renderIndividualChat(); // Render content for the specific chat
            renderChatList(); // Re-render the chat list to update the unread badge
        }

        function renderIndividualChat() {
            const chatHeader = document.getElementById('individual-chat-header');
            const chatMessagesContainer = document.getElementById('chat-messages');
            chatHeader.textContent = appState.currentRecipient;
            chatMessagesContainer.innerHTML = ''; // Clear existing messages

            // Find the current conversation object
            const currentConvo = appState.conversations.find(c => c.name === appState.currentRecipient);
            const messages = currentConvo ? currentConvo.messages : []; // Use messages from appState

            messages.forEach(msg => {
                const div = document.createElement('div');
                if (msg.sender === 'system') {
                    // For "Payment sent" messages (left-aligned, distinct style)
                    div.className = 'flex justify-start flex-col my-2';
                    div.innerHTML = `
                        <div class="text-xs text-gray-500 text-left ml-2 mb-1">${msg.time}</div>
                        <div class="bg-green-50 text-green-800 border border-green-200 rounded-lg px-3 py-2 max-w-[80%] mr-auto break-words">
                            ${msg.text}
                        </div>
                    `;
                } else if (msg.sender === 'system-incoming') {
                    // For "Payment received" messages (left-aligned, distinct style)
                    div.className = 'flex justify-start flex-col my-2';
                    div.innerHTML = `
                        <div class="text-xs text-gray-500 text-left ml-2 mb-1">${msg.time}</div>
                        <div class="bg-blue-50 text-blue-800 border border-blue-200 rounded-lg px-3 py-2 max-w-[80%] mr-auto break-words">
                            ${msg.text}
                        </div>
                    `;
                }
                else {
                    // Existing logic for user/other messages
                    div.className = `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} flex-col`;
                    div.innerHTML = `
                        <div class="text-xs text-gray-500 ${msg.sender === 'user' ? 'text-right mr-2' : 'text-left ml-2'} mb-1">${msg.time}</div>
                        <div class="${msg.sender === 'user' ? 'bg-green-100 text-green-900 ml-auto' : 'bg-gray-200 mr-auto'} rounded-lg px-3 py-2 max-w-[80%] break-words">
                            ${msg.text}
                        </div>
                    `;
                }
                chatMessagesContainer.appendChild(div);
            });

            // Logic to hide/show suggestion/accept buttons based on whether a payment confirmation system message exists
            const hasPaymentConfirmation = messages.some(msg => 
                (msg.sender === 'system' || msg.sender === 'system-incoming') && msg.text.includes('Payment')
            );

            if (!hasPaymentConfirmation) { // Only show suggestions if no payment confirmation yet
                if (appState.currentRecipient === 'Ethan') {
                    const suggestionButton = `
                        <div class="flex justify-start mt-3">
                            <button class="bg-white border border-green-500 text-green-600 font-semibold rounded-lg px-4 py-2 hover:bg-green-50 transition-colors" onclick="startPayment(50, 'Ethan')">Suggestion: Pay $50</button>
                        </div>
                    `;
                    chatMessagesContainer.innerHTML += suggestionButton;
                } else {
                    const pendingIncomingTx = getPendingIncomingTransaction(appState.currentRecipient);
                    if (pendingIncomingTx) {
                        const acceptButton = `
                            <div class="flex justify-start mt-3">
                                <button class="bg-white border border-green-500 text-green-600 font-semibold rounded-lg px-4 py-2 hover:bg-green-50 transition-colors" onclick="startReceivingMoney(${pendingIncomingTx.amount}, '${pendingIncomingTx.name}', '${pendingIncomingTx.id}')">
                                    Accept $${pendingIncomingTx.amount.toFixed(2)}
                                </button>
                            </div>
                        `;
                        chatMessagesContainer.innerHTML += acceptButton;
                    }
                }
            }
        }


        function renderTransactionHistory(filter) {
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            let filteredTransactions = appState.transactions;
            
            if (filter === 'completed') {
                filteredTransactions = appState.transactions.filter(t => t.status === 'completed');
            } else if (filter === 'incomplete') {
                filteredTransactions = appState.transactions.filter(t => t.status === 'incomplete');
            } else if (filter === 'outgoing') {
                filteredTransactions = appState.transactions.filter(t => t.type === 'outgoing');
            } else if (filter === 'incoming') {
                filteredTransactions = appState.transactions.filter(t => t.type === 'incoming');
            } else if (filter === 'pending') { // New filter for pending transactions
                filteredTransactions = appState.transactions.filter(t => t.status === 'pending');
            }
            // 'all' filter doesn't require further filtering

            if (filteredTransactions.length === 0) {
                list.innerHTML = `<li class="text-center text-gray-500 py-8">No transactions found.</li>`;
                return;
            }

            // Sort transactions by date (most recent first) - simple string comparison for "Today", "Apr 18" etc.
            // For a real app, use Date objects for accurate sorting.
            filteredTransactions.sort((a, b) => {
                const dateA = a.date === 'Today' ? new Date() : new Date(a.date + ' 2025'); // Assuming current year
                const dateB = b.date === 'Today' ? new Date() : new Date(b.date + ' 2025'); // Assuming current year
                return dateB - dateA;
            });


            filteredTransactions.forEach(t => {
                const item = document.createElement('li');
                const amountColor = t.type === 'incoming' ? 'text-green-600' : 'text-gray-800';
                let typeLabel = t.type === 'incoming' ? 'Incoming' : 'Outgoing';
                if (t.status === 'pending') {
                    typeLabel += ' (Pending)';
                } else if (t.status === 'incomplete') {
                    typeLabel += ' (Incomplete)';
                }


                item.className = 'flex items-center justify-between p-3 bg-white rounded-lg shadow-sm';
                item.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center mr-3 font-bold text-gray-600">${t.name.charAt(0)}</div>
                        <div>
                            <div class="font-semibold">${t.name}</div>
                            <div class="text-xs text-gray-500">${t.date} &bull; ${t.bankAccount}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-lg ${amountColor}">$${t.amount.toFixed(2)}</div>
                        <div class="text-xs ${t.status === 'incomplete' || t.status === 'pending' ? 'text-red-500' : 'text-gray-500'} capitalize">${typeLabel}</div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function renderTransactionsChart() {
            const ctx = document.getElementById('transactionsChart').getContext('2d');
            if (appState.transactionsChart) {
                appState.transactionsChart.destroy();
            }

            const completedTransactions = appState.transactions.filter(t => t.status === 'completed');
            const spendingByPerson = completedTransactions.reduce((acc, t) => {
                acc[t.name] = (acc[t.name] || 0) + t.amount;
                return acc;
            }, {});

            const labels = Object.keys(spendingByPerson);
            const data = Object.values(spendingByPerson);

            appState.transactionsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Sent',
                        data: data,
                        backgroundColor: 'rgba(22, 163, 74, 0.7)',
                        borderColor: 'rgba(22, 163, 74, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false }, title: { display: true, text: 'Total Payments to Recipients' } }
                }
            });
        }
        
        function showModal(content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = content;
            modalContainer.appendChild(modal);
        }

        function closeModal() {
            modalContainer.innerHTML = '';
        }

        function getUniqueRecipients() {
            const recipients = new Set();
            appState.transactions.forEach(t => recipients.add(t.name));
            return Array.from(recipients);
        }

        // New helper function to get a pending incoming transaction
        function getPendingIncomingTransaction(recipientName) {
            return appState.transactions.find(t =>
                t.name === recipientName && t.type === 'incoming' && t.status === 'pending'
            );
        }

        // --- Linked Accounts Functions ---
        function renderLinkedAccounts() {
            const linkedAccountsList = document.getElementById('linked-accounts-list');
            linkedAccountsList.innerHTML = ''; // Clear existing list

            if (appState.linkedAccounts.length === 0) {
                linkedAccountsList.innerHTML = `<div class="p-3 text-gray-500 text-center">No linked accounts.</div>`;
            } else {
                appState.linkedAccounts.forEach(account => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 border-b border-gray-100 last:border-b-0';
                    div.innerHTML = `
                        <span>${account}</span>
                        <button class="text-red-500 text-sm font-semibold hover:text-red-700" onclick="unlinkAccount('${account}')">Unlink</button>
                    `;
                    linkedAccountsList.appendChild(div);
                });
            }
            // Add the "Link new account" button directly in the settings view
            const linkNewAccountButton = document.createElement('button');
            linkNewAccountButton.className = 'w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors mt-6';
            linkNewAccountButton.textContent = 'Link new account';
            linkNewAccountButton.onclick = showBankSelection; // Changed to showBankSelection
            linkedAccountsList.appendChild(linkNewAccountButton);
        }

        function unlinkAccount(accountName) {
            if (appState.linkedAccounts.length > 1) { // Prevent unlinking if it's the only account
                appState.linkedAccounts = appState.linkedAccounts.filter(account => account !== accountName);
                renderLinkedAccounts(); // Re-render the list on the main settings page
                // If the modal is open, it will be re-rendered when showLinkedAccounts is called again.
            } else {
                // Optionally show a message that you can't unlink the last account
                alert("Cannot unlink the last account. Please link another account first if you wish to remove this one."); // Using alert for simplicity, would use a custom modal in a real app
            }
        }

        // --- Payment Flow Functions ---
        function handleAccountSelection(selectElement) {
            appState.currentAccount = selectElement.value; // Update the selected account in appState
            if (selectElement.value === 'link-new-bank') {
                appState.paymentFlowActive = true; // Set flag when linking from payment flow
                closeModal(); // Close the current payment modal
                showBankSelection(); 
                // No need to reset selectElement.value here, as the modal will be closed and re-opened.
            }
        }

        // New function to handle selection in the receive money flow
        function handleReceiveAccountSelection(selectElement) {
            if (selectElement.value === 'link-new-bank') {
                appState.receiveFlowActive = true; // Set flag when linking from receive flow
                closeModal(); // Close the current receive modal
                showBankSelection(); 
                // No need to reset selectElement.value here, as the modal will be closed and re-opened.
            } else {
                appState.currentAccount = selectElement.value;
            }
        }

        function updateSelectedRecipient(selectElement) {
            const selectedValue = selectElement.value;
            if (selectedValue === 'link-new-bank') {
                closeModal(); // Close the current payment modal
                showBankSelection(); // Changed to showBankSelection
            } else {
                appState.currentRecipient = selectedValue;
            }
        }


        function startPayment(suggestedAmount = null, suggestedRecipient = null) {
            appState.currentPaymentAmount = suggestedAmount || 0;
            appState.currentRecipient = suggestedRecipient || appState.currentRecipient; 

            const uniqueRecipients = getUniqueRecipients();
            // Ensure Ethan is always an option, and default to Ethan if no suggestedRecipient
            if (!uniqueRecipients.includes('Ethan')) {
                uniqueRecipients.unshift('Ethan');
            }
            if (!appState.currentRecipient && uniqueRecipients.length > 0) {
                appState.currentRecipient = uniqueRecipients[0];
            } else if (!appState.currentRecipient && uniqueRecipients.length === 0) {
                appState.currentRecipient = 'New Contact'; // Fallback if no history
            }
            
            const recipientOptions = uniqueRecipients.map(name => 
                `<option value="${name}" ${name === appState.currentRecipient ? 'selected' : ''}>${name}</option>`
            ).join('');

            // Dynamically generate account options from appState.linkedAccounts
            let accountOptions = appState.linkedAccounts.map(account => 
                `<option value="${account}" ${account === appState.currentAccount ? 'selected' : ''}>${account}</option>`
            ).join('');
            // Add the "Add new bank or link new bank" option
            accountOptions += `<option value="link-new-bank">Add new bank or link new bank</option>`;

            const content = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-sm animate-fade-in-up">
                    <div class="p-6 text-center">
                        <div class="text-gray-500 text-sm">PAYING</div>
                        <div class="font-bold text-2xl mt-1">
                            <select id="recipientSelect" class="w-full text-center bg-transparent border-b-2 border-gray-300 focus:outline-none focus:border-green-500" onchange="updateSelectedRecipient(this)">
                                ${recipientOptions}
                            </select>
                        </div>
                        <div class="text-5xl font-bold my-6 flex justify-center items-center">
                            <span>$</span>
                            <input type="number" id="paymentAmountInput" value="${appState.currentPaymentAmount.toFixed(2)}" class="w-32 text-center bg-transparent border-b-2 border-gray-300 focus:outline-none focus:border-green-500" oninput="updatePaymentAmount(this.value)">
                        </div>
                        <div class="text-left">
                            <label class="text-sm font-semibold text-gray-600">Note (Optional)</label>
                            <input type="text" placeholder="e.g., For the tickets" class="w-full mt-1 border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                         <div class="text-left mt-4">
                            <label class="text-sm font-semibold text-gray-600">Account</label>
                            <select id="accountSelect" class="w-full mt-1 border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" onchange="handleAccountSelection(this)">
                                ${accountOptions}
                            </select>
                        </div>
                        <div class="mt-8">
                            <button class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors" onclick="showPinAuth()">Confirm & Send</button>
                            <button class="w-full mt-2 text-gray-600 font-semibold py-2 rounded-lg hover:bg-gray-100" onclick="closeModal()">Cancel</button>
                        </div>
                    </div>
                </div>`;
            showModal(content);
        }

        function updatePaymentAmount(value) {
            appState.currentPaymentAmount = parseFloat(value) || 0;
        }

        function showPinAuth() {
            appState.currentPin = '';
            const content = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
                    <h2 class="text-2xl font-bold">Enter PIN</h2>
                    <p class="text-gray-600 mt-2">Enter your PIN to send the payment.</p>
                    <div class="flex justify-center space-x-3 my-6" id="pinDisplay">
                        <div class="pin-digit"></div>
                        <div class="pin-digit"></div>
                        <div class="pin-digit"></div>
                        <div class="pin-digit"></div>
                    </div>
                    <p id="pinError" class="text-red-500 text-sm mb-4 hidden">Incorrect PIN. Please try again.</p>
                    <div class="grid grid-cols-2 gap-4 my-6">
                         <button class="w-full border border-gray-300 text-gray-700 font-semibold py-2 rounded-lg hover:bg-gray-100" onclick="checkPin('biometric')">Use Face ID</button>
                         <button class="w-full border border-gray-300 text-gray-700 font-semibold py-2 rounded-lg hover:bg-gray-100" onclick="checkPin('biometric')">Use Fingerprint</button>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        ${[1, 2, 3, 4, 5, 6, 7, 8, 9, '', 0, '‚å´'].map(k => `<button class="text-2xl py-3 rounded-lg hover:bg-gray-100" ${k === '' ? 'disabled' : ''} onclick="handlePinInput('${k}')">${k}</button>`).join('')}
                    </div>
                    <button class="w-full mt-6 text-gray-600 font-semibold py-2" onclick="startPayment(appState.currentPaymentAmount, appState.currentRecipient)">Cancel</button>
                </div>
            `;
            showModal(content);
            updatePinDisplay(); // Ensure PIN display is cleared and updated
        }

        function updatePinDisplay() {
            const pinDigits = document.querySelectorAll('#pinDisplay .pin-digit');
            pinDigits.forEach((digit, index) => {
                digit.textContent = appState.currentPin[index] ? '‚Ä¢' : '';
            });
        }

        function handlePinInput(key) {
            document.getElementById('pinError').classList.add('hidden');

            if (key === '‚å´') {
                appState.currentPin = appState.currentPin.slice(0, -1);
            } else if (appState.currentPin.length < 4) {
                appState.currentPin += key;
            }
            updatePinDisplay();

            if (appState.currentPin.length === 4) {
                // Determine which checkPin function to call based on the current modal
                if (modalContainer.querySelector('h2').textContent.includes('Enter PIN') && modalContainer.querySelector('p').textContent.includes('send the payment')) {
                     // If it's the general PIN entry for sending money
                    setTimeout(() => checkPin('numeric'), 300);
                } else if (modalContainer.querySelector('h2').textContent.includes('Enter PIN') && modalContainer.querySelector('p').textContent.includes('accept the payment')) {
                    // If it's the receive PIN entry for accepting money
                    setTimeout(() => checkReceivePin('numeric'), 300);
                }
            }
        }

        function checkPin(type) {
            if (type === 'biometric' || appState.currentPin === appState.correctPin) {
                showPaymentSuccess();
            } else {
                document.getElementById('pinError').classList.remove('hidden');
                appState.currentPin = '';
                updatePinDisplay();
            }
        }
        
        function showPaymentSuccess() {
            const newTxId = `TX${Math.floor(Math.random() * 900000000) + 100000000}`;
            const now = new Date();
            const dateString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')} ${now.getHours() >= 12 ? 'PM' : 'AM'}`;

            const newTransaction = {
                id: (appState.transactions.length + 1).toString(),
                name: appState.currentRecipient,
                date: 'Today', // Keep 'Today' for the display in history
                amount: appState.currentPaymentAmount,
                status: 'completed',
                txId: newTxId,
                bankAccount: appState.currentAccount, // Use the selected account
                type: 'outgoing' // New transactions are outgoing
            };
            appState.transactions.push(newTransaction); 

            // Also update the conversation's last message and time for sorting
            const convoIndex = appState.conversations.findIndex(c => c.name === appState.currentRecipient);
            if (convoIndex !== -1) {
                const chatMessage = {
                    sender: 'system', // New type for system messages
                    text: `Payment sent: $${appState.currentPaymentAmount.toFixed(2)}`,
                    time: dateString
                };
                appState.conversations[convoIndex].messages.push(chatMessage); // Add to conversation's messages
                appState.conversations[convoIndex].lastMessage = chatMessage.text; // Update last message for chat list
                appState.conversations[convoIndex].time = `Today ${dateString}`; // Update time for chat list sorting
                appState.conversations[convoIndex].unread = 0; // Assuming sending a message makes it read
            }


             const content = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-8 text-center">
                    <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto">
                        <span class="text-white text-5xl">‚úì</span>
                    </div>
                    <h2 class="text-3xl font-bold mt-6">Payment Sent</h2>
                    <p class="text-gray-600 text-lg mt-2">to ${appState.currentRecipient}</p>
                    <p class="text-4xl font-bold my-4">$${appState.currentPaymentAmount.toFixed(2)}</p>
                    <p class="text-sm text-gray-500">${newTxId}</p>
                    <button class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors mt-8" onclick="closeModalAndRefreshHistory()">Done</button>
                </div>
            `;
            showModal(content);
        }

        function closeModalAndRefreshHistory() {
            closeModal();
            // Re-render history and chart after successful payment
            renderTransactionHistory('all');
            renderTransactionsChart();
            renderIndividualChat(); // Re-render chat to remove "Accept" button if applicable
            renderChatList(); // Re-render chat list to reflect updated conversation order/status
        }


        function showLinkedAccounts(event) {
            event.preventDefault();
            const content = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Linked Accounts</h2>
                        <button class="text-2xl" onclick="closeModal()">&times;</button>
                     </div>
                    <div id="linked-accounts-modal-list" class="space-y-3">
                        <!-- Accounts will be rendered here -->
                    </div>
                    <button class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors mt-6" onclick="showBankSelection()">Link new account</button>
                </div>
            `;
            showModal(content);
            // Render accounts inside the modal
            const linkedAccountsModalList = document.getElementById('linked-accounts-modal-list');
            if (appState.linkedAccounts.length === 0) {
                linkedAccountsModalList.innerHTML = `<div class="p-3 text-gray-500 text-center">No linked accounts.</div>`;
            } else {
                appState.linkedAccounts.forEach(account => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 border rounded-lg';
                    div.innerHTML = `
                        <span>${account}</span>
                        <button class="text-red-500 text-sm font-semibold hover:text-red-700" onclick="unlinkAccount('${account}')">Unlink</button>
                    `;
                    linkedAccountsModalList.appendChild(div);
                });
            }
        }

        // New function to show bank selection
        function showBankSelection() {
            const banks = ['MyBank', 'National Trust', 'Financial Partners', 'Citizens Bank', 'Founders Federal'];
            const content = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Select Your Bank</h2>
                        <button class="text-2xl" onclick="closeModal()">&times;</button>
                     </div>
                     <p class="text-gray-600 mb-4">Choose the bank you wish to link.</p>
                     <div class="space-y-2">
                        ${banks.map(bank => `<button class="w-full text-left p-3 border rounded-lg hover:bg-gray-50" onclick="showBankLoginForSelectedBank('${bank}')">${bank}</button>`).join('')}
                     </div>
                     <button class="w-full mt-6 text-gray-600 font-semibold py-2" onclick="closeModal()">Cancel</button>
                </div>
            `;
            showModal(content);
        }

        // New function for bank-specific login
        function showBankLoginForSelectedBank(bankName) {
            appState.selectedBankToLink = bankName; // Store the selected bank
            const content = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Login to ${bankName}</h2>
                        <button class="text-2xl" onclick="showBankSelection()">&times;</button>
                    </div>
                    <p class="text-gray-600 mb-4">Enter your credentials for ${bankName} to link your account.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="bankUsername" class="block text-sm font-semibold text-gray-600 mb-1">Username</label>
                            <input type="text" id="bankUsername" class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Enter username">
                        </div>
                        <div>
                            <label for="bankPassword" class="block text-sm font-semibold text-gray-600 mb-1">Password</label>
                            <input type="password" id="bankPassword" class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Enter password">
                        </div>
                        <p id="bankLoginError" class="text-red-500 text-sm hidden">Invalid credentials. Please try again.</p>
                    </div>
                    <button class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors mt-6" onclick="authenticateBank('${bankName}')">Continue</button>
                    <button class="w-full mt-2 text-gray-600 font-semibold py-2" onclick="showBankSelection()">Back to Bank Selection</button>
                </div>
            `;
            showModal(content);
        }

        function authenticateBank(bankName) {
            const username = document.getElementById('bankUsername').value;
            const password = document.getElementById('bankPassword').value;
            const errorDisplay = document.getElementById('bankLoginError');

            if (username && password) {
                errorDisplay.classList.add('hidden');
                // Simulate OAuth authentication
                const content = `
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-8 text-center">
                        <h2 class="text-2xl font-bold">Authenticating...</h2>
                        <p class="text-gray-600 mt-2">Authenticating with ${bankName} via OAuth. Please wait.</p>
                        <div class="my-6">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto"></div>
                        </div>
                    </div>
                `;
                showModal(content);

                setTimeout(() => {
                    linkNewBank(bankName);
                }, 2000); // Simulate network delay for OAuth
            } else {
                errorDisplay.classList.remove('hidden');
            }
        }
        
        function linkNewBank(bankName) {
            if (!appState.linkedAccounts.includes(bankName)) {
                appState.linkedAccounts.push(bankName);
            }
            renderLinkedAccounts(); // Update the main settings page's linked accounts list
            showBankLinkedSuccess(bankName); // This will handle navigation based on appState.paymentFlowActive
        }

        function showBankLinkedSuccess(bankName) {
             const content = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-8 text-center">
                    <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto">
                        <span class="text-white text-5xl">‚úì</span>
                    </div>
                    <h2 class="text-3xl font-bold mt-6">Bank linked successfully</h2>
                    <p class="text-gray-600 text-lg mt-2">${bankName} is now linked.</p>
                    ${appState.paymentFlowActive ?
                        `<button class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors mt-8" onclick="closeModalAndReturnToPayment('${bankName}')">Done</button>` :
                        appState.receiveFlowActive ?
                        `<button class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors mt-8" onclick="closeModalAndReturnToReceive('${bankName}')">Done</button>` :
                        `<button class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors mt-8" onclick="showLinkedAccounts(event)">Done</button>`
                    }
                </div>
            `;
            showModal(content);
        }

        function closeModalAndReturnToPayment(newlyLinkedBankName) {
            closeModal();
            appState.paymentFlowActive = false; // Reset the flag
            appState.currentAccount = newlyLinkedBankName; // Set the newly linked bank as the current selected account
            startPayment(appState.currentPaymentAmount, appState.currentRecipient); // Re-open the payment modal
        }

        // --- New Functions for Receiving Money ---
        function startReceivingMoney(amount, sender, txId) {
            appState.currentReceiveAmount = amount;
            appState.currentReceiveSender = sender;
            appState.currentReceiveTxId = txId;

            // Dynamically generate account options from appState.linkedAccounts for deposit
            let accountOptions = appState.linkedAccounts.map(account =>
                `<option value="${account}" ${account === appState.currentAccount ? 'selected' : ''}>${account}</option>`
            ).join('');
            // Add the "Add new bank or link new bank" option for receiving
            accountOptions += `<option value="link-new-bank">Add new bank or link new bank</option>`;


            const content = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-sm animate-fade-in-up">
                    <div class="p-6 text-center">
                        <div class="text-gray-500 text-sm">RECEIVING FROM</div>
                        <div class="font-bold text-2xl mt-1">${sender}</div>
                        <div class="text-5xl font-bold my-6">$${amount.toFixed(2)}</div>
                        <div class="text-left mt-4">
                            <label class="text-sm font-semibold text-gray-600">Deposit to Account</label>
                            <select id="receiveAccountSelect" class="w-full mt-1 border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" onchange="handleReceiveAccountSelection(this)">
                                ${accountOptions}
                            </select>
                        </div>
                        <div class="mt-8">
                            <button class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors" onclick="showReceivePinAuth()">Confirm Acceptance</button>
                            <button class="w-full mt-2 text-gray-600 font-semibold py-2 rounded-lg hover:bg-gray-100" onclick="closeModal()">Cancel</button>
                        </div>
                    </div>
                </div>`;
            showModal(content);
        }

        function showReceivePinAuth() {
            appState.currentPin = ''; // Reset PIN
            const content = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
                    <h2 class="text-2xl font-bold">Enter PIN</h2>
                    <p class="text-gray-600 mt-2">Enter your PIN to accept the payment.</p>
                    <div class="flex justify-center space-x-3 my-6" id="pinDisplay">
                        <div class="pin-digit"></div>
                        <div class="pin-digit"></div>
                        <div class="pin-digit"></div>
                        <div class="pin-digit"></div>
                    </div>
                    <p id="pinError" class="text-red-500 text-sm mb-4 hidden">Incorrect PIN. Please try again.</p>
                    <div class="grid grid-cols-2 gap-4 my-6">
                         <button class="w-full border border-gray-300 text-gray-700 font-semibold py-2 rounded-lg hover:bg-gray-100" onclick="checkReceivePin('biometric')">Use Face ID</button>
                         <button class="w-full border border-gray-300 text-gray-700 font-semibold py-2 rounded-lg hover:bg-gray-100" onclick="checkReceivePin('biometric')">Use Fingerprint</button>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        ${[1, 2, 3, 4, 5, 6, 7, 8, 9, '', 0, '‚å´'].map(k => `<button class="text-2xl py-3 rounded-lg hover:bg-gray-100" ${k === '' ? 'disabled' : ''} onclick="handlePinInput('${k}')">${k}</button>`).join('')}
                    </div>
                    <button class="w-full mt-6 text-gray-600 font-semibold py-2" onclick="startReceivingMoney(appState.currentReceiveAmount, appState.currentReceiveSender, appState.currentReceiveTxId)">Cancel</button>
                </div>
            `;
            showModal(content);
            updatePinDisplay(); // Ensure PIN display is cleared and updated
        }

        function checkReceivePin(type) {
            if (type === 'biometric' || appState.currentPin === appState.correctPin) {
                const selectedAccount = document.getElementById('receiveAccountSelect').value;
                showReceiveSuccess(selectedAccount);
            } else {
                document.getElementById('pinError').classList.remove('hidden');
                appState.currentPin = '';
                updatePinDisplay();
            }
        }

        function showReceiveSuccess(destinationAccount) {
            // Find the pending transaction and update its status and bankAccount
            const txIndex = appState.transactions.findIndex(t => t.id === appState.currentReceiveTxId);
            if (txIndex !== -1) {
                appState.transactions[txIndex].status = 'completed';
                appState.transactions[txIndex].bankAccount = destinationAccount; // Update destination account
            } else {
                // Fallback: If pending transaction not found, add as a new completed incoming transaction
                const newTxId = `TX${Math.floor(Math.random() * 900000000) + 100000000}`;
                const newTransaction = {
                    id: (appState.transactions.length + 1).toString(),
                    name: appState.currentReceiveSender,
                    date: 'Today',
                    amount: appState.currentReceiveAmount,
                    status: 'completed',
                    txId: newTxId,
                    bankAccount: destinationAccount,
                    type: 'incoming'
                };
                appState.transactions.push(newTransaction);
            }
            
            const now = new Date();
            const dateString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')} ${now.getHours() >= 12 ? 'PM' : 'AM'}`;

            // Update the conversation's last message and time for sorting
            const convoIndex = appState.conversations.findIndex(c => c.name === appState.currentReceiveSender);
            if (convoIndex !== -1) {
                const chatMessage = {
                    sender: 'system-incoming', // New type for incoming system messages
                    text: `Payment received: $${appState.currentReceiveAmount.toFixed(2)}`,
                    time: dateString
                };
                appState.conversations[convoIndex].messages.push(chatMessage); // Add to conversation's messages
                appState.conversations[convoIndex].lastMessage = chatMessage.text; // Update last message for chat list
                appState.conversations[convoIndex].time = `Today ${dateString}`; // Update time for chat list sorting
                appState.conversations[convoIndex].unread = 0; // Assuming accepting makes it read
            }


            const content = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-8 text-center">
                    <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto">
                        <span class="text-white text-5xl">‚úì</span>
                    </div>
                    <h2 class="text-3xl font-bold mt-6">Payment Received!</h2>
                    <p class="text-gray-600 text-lg mt-2">from ${appState.currentReceiveSender}</p>
                    <p class="text-4xl font-bold my-4">$${appState.currentReceiveAmount.toFixed(2)}</p>
                    <p class="text-sm text-gray-500">Deposited to ${destinationAccount}</p>
                    <button class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors mt-8" onclick="closeModalAndRefreshHistory()">Done</button>
                </div>
            `;
            showModal(content);

            // After accepting, remove the unread badge from the conversation if it exists
            const unreadConvoIndex = appState.conversations.findIndex(c => c.name === appState.currentReceiveSender);
            if (unreadConvoIndex !== -1) {
                appState.conversations[unreadConvoIndex].unread = 0;
                // Re-render the chat list to update the unread badge
                renderChatList();
            }
        }

        // New function to return to the receive money modal after linking a bank
        function closeModalAndReturnToReceive(newlyLinkedBankName) {
            closeModal();
            appState.receiveFlowActive = false; // Reset the flag
            appState.currentAccount = newlyLinkedBankName; // Set the newly linked bank as the current selected account
            // Re-open the receive money modal with the original details and the new account selected
            startReceivingMoney(appState.currentReceiveAmount, appState.currentReceiveSender, appState.currentReceiveTxId);
        }


        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => navigateToTab(tab.dataset.view));
            });
            document.querySelectorAll('.history-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                     document.querySelectorAll('.history-filter-btn').forEach(b => {
                        b.classList.remove('bg-green-600', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    btn.classList.add('bg-green-600', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    renderTransactionHistory(btn.dataset.filter);
                });
            });
            
            const style = document.createElement('style');
            style.innerHTML = `
                .toggle-checkbox:checked { right: 0; border-color: #16a34a; }
                .toggle-checkbox:checked + .toggle-label { background-color: #16a34a; }
            `;
            document.head.appendChild(style);

            // Initial view on load
            navigateToTab('chat-list');
        });

    </script>
</body>
</html>
